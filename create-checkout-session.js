const stripe=require('stripe')(process.env.STRIPE_SECRET_KEY);
exports.handler=async (event)=>{if(event.httpMethod!=='POST'){return{statusCode:405,body:'Method Not Allowed'}}try{const {items=[],successUrl,cancelUrl}=JSON.parse(event.body||'{}');if(!Array.isArray(items)||items.length===0){return{statusCode:400,body:'No items provided'}}const line_items=items.map(i=>({quantity:Math.max(1,parseInt(i.qty||1,10)),price_data:{currency:'nzd',unit_amount:Math.round(Number(i.price)*100),product_data:{name:i.title}}}));const session=await stripe.checkout.sessions.create({mode:'payment',line_items,success_url:successUrl||`${process.env.SITE_URL||''}/success.html`,cancel_url:cancelUrl||`${process.env.SITE_URL||''}/cancel.html`,shipping_address_collection:{allowed_countries:['NZ','AU']}});return{statusCode:200,body:JSON.stringify({url:session.url})}}catch(err){console.error(err);return{statusCode:500,body:JSON.stringify({error:err.message})}}};